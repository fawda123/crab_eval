<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Exploration of crab dissolution</title>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>



<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("section-TOC");
});
</script>

<!-- code folding -->






<div class="fluid-row" id="section-header">



<h1 class="title toc-ignore">Exploration of crab dissolution</h1>

</div>


<a href="https://github.com/fawda123/crab_eval/" class="github-corner" aria-label="View source on Github"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#64CEAA; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>
<style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
<div class="col-sm-12">
<div class="col-sm-4">
<div class="form-group shiny-input-container">
<label class="control-label" for="lng">Select length measure:</label>
<div>
<select id="lng"><option value="CL" selected>CL</option>
<option value="CW">CW</option>
<option value="R-DCS">R-DCS</option>
<option value="TL">TL</option></select>
<script type="application/json" data-for="lng" data-nonempty="">{}</script>
</div>
</div>
</div>
<div class="col-sm-4">
<div class="form-group shiny-input-container">
<label class="control-label" for="logm">Log models (abundance only):</label>
<div>
<select id="logm"><option value="TRUE" selected>TRUE</option>
<option value="FALSE">FALSE</option></select>
<script type="application/json" data-for="logm" data-nonempty="">{}</script>
</div>
</div>
</div>
</div>
<div id="section-test" class="section level1 tabset">
<h1>test</h1>
<div id="section-length-vs-dissolution" class="section level2">
<h2>Length vs dissolution</h2>
<p>These plots show the relationship between dissolution and length for the selected measures above. Each point is based on an aggregated dissolution measure (as an average from three replicates) and the corresponding lengths for the same station. The length values are also aggregated but represent average length across multiple individuals that were collected at a station. The error bars around the length represent 95% confidence intervals for the length measurements. The regression lines were fit for the average dissolution and length measurements, where the black line is for all points and the dotted line is fit only for sites identified as onshore.</p>
<div id="outd88d48713f454472" class="shiny-plot-output" style="width: 100% ; height: "></div>
<p>The table shows summary statistics for each linear model in the above plot. The crab body location is where the dissolution was measured (plot facets) and the model subset indicates the appropriate regression model in each plot facet. The summary information are F-statistics (<code>F.stat</code>, whole model), p-value (<code>p.mod</code>, whole model), R-squared (<code>R2</code>), <code>intercept</code> (model intercept, can be in log-space), <code>intercept</code> (model intercept, can be in log-space), <code>slope</code> (slope estimate for length vs dissolution, can be in log-space), t-statistic (<code>t.stat</code>, test statistics for slope), and p-value (<code>p.slope</code>, significance of slope). ns: p &gt;= 0.05, * p &lt; 0.05, ** p &lt; 0.01 <div id="outc70ce1ec56b0df33" class="shiny-html-output"></div></p>
</div>
<div id="section-abundance-vs-dissolution" class="section level2">
<h2>Abundance vs dissolution</h2>
<p>These plots show the relationship between dissolution and abundance for the selected measures above. Each point is based on an aggregated dissolution measure (as an average from three replicates) and the corresponding abundance (count) for the same station. The regression lines were fit for the average dissolution and abundance measurements, where the black line is for all points and the dotted line is fit only for sites identified as onshore.</p>
<div id="out0accb2ecb8c41d27" class="shiny-plot-output" style="width: 100% ; height: "></div>
<p>The table shows summary statistics for each linear model in the above plot. The crab body location is where the dissolution was measured (plot facets) and the model subset indicates the appropriate regression model in each plot facet. The summary information are F-statistics (<code>F.stat</code>, whole model), p-value (<code>p.mod</code>, whole model), R-squared (<code>R2</code>), <code>intercept</code> (model intercept, can be in log-space), <code>slope</code> (slope estimate for length vs dissolution, can be in log-space), t-statistic (<code>t.stat</code>, test statistics for slope), and p-value (<code>p.slope</code>, significance of slope). ns: p &gt;= 0.05, * p &lt; 0.05, ** p &lt; 0.01 <div id="out32a8bc59fff101ef" class="shiny-html-output"></div></p>
</div>
<div id="section-abundance-vs-length" class="section level2">
<h2>Abundance vs length</h2>
<p>Each point is based on an crab counts and the corresponding lengths for the same station. The length values are also aggregated but represent average length across multiple individuals that were collected at a station. The error bars around the length represent 95% confidence intervals for the length measurements. The regression lines were fit for the counts and average length measurements, where the black line is for all points and the dotted line is fit only for sites identified as onshore.</p>
<div id="outcb41d1ffebbfccbf" class="shiny-plot-output" style="width: 100% ; height: "></div>
<p>The table shows summary statistics for each linear model in the above plot. The model subset indicates the appropriate regression model in each plot facet. The summary information are F-statistics (<code>F.stat</code>, whole model), p-value (<code>p.mod</code>, whole model), R-squared (<code>R2</code>), <code>intercept</code> (model intercept, can be in log-space), <code>slope</code> (slope estimate for length vs dissolution, can be in log-space), t-statistic (<code>t.stat</code>, test statistics for slope), and p-value (<code>p.slope</code>, significance of slope). ns: p &gt;= 0.05, * p &lt; 0.05, ** p &lt; 0.01 <div id="out2922e2327f835fe0" class="shiny-html-output"></div></p>
</div>
<div id="section-environmental-data" class="section level2 tabset tabset-pills">
<h2>Environmental data</h2>
<p>These tabs show the relationships of environmental variables with dissolution, length, and abundances. The drop-down menu below can be used to select environmental data from a specific depth. Values for delta-pH are based on the difference between the observed value at the selected depth and that at the surface. Stations 109 and 128 are excluded in the analysis because environmental data were unavailable.</p>
<div class="form-group shiny-input-container">
<label class="control-label" for="dep">Select depth for environment:</label>
<div>
<select id="dep"><option value="10">10</option>
<option value="20">20</option>
<option value="30">30</option>
<option value="40">40</option>
<option value="50" selected>50</option>
<option value="60">60</option>
<option value="70">70</option>
<option value="80">80</option>
<option value="90">90</option>
<option value="100">100</option>
<option value="110">110</option>
<option value="120">120</option>
<option value="130">130</option>
<option value="140">140</option>
<option value="150">150</option>
<option value="160">160</option>
<option value="170">170</option>
<option value="180">180</option>
<option value="190">190</option>
<option value="200">200</option></select>
<script type="application/json" data-for="dep" data-nonempty="">{}</script>
</div>
</div>
<div id="section-dissolution" class="section level3">
<h3>Dissolution</h3>
<div id="out80c2474bed0408bd" class="shiny-plot-output" style="width: 100% ; height: "></div>
<div id="out3cb9895563c4a482" class="shiny-html-output"></div>
</div>
<div id="section-length" class="section level3">
<h3>Length</h3>
<div id="outa06587f7b891c7ad" class="shiny-plot-output" style="width: 100% ; height: "></div>
<div id="outd00ab7e9d7202cac" class="shiny-html-output"></div>
</div>
<div id="section-abundance" class="section level3">
<h3>Abundance</h3>
<div id="oute5aba5e25e3c8aaf" class="shiny-plot-output" style="width: 100% ; height: "></div>
<div id="out83fd4ee97085c790" class="shiny-html-output"></div>
</div>
<div id="section-presenceabsence" class="section level3">
<h3>Presence/absence</h3>
<div id="outc55d6e575b7efc6f" class="shiny-plot-output" style="width: 100% ; height: "></div>
<div id="out6cf65045027e59db" class="shiny-html-output"></div>
</div>
<div id="section-bivariate-comparisons" class="section level3">
<h3>Bivariate comparisons</h3>
<div id="out2736aad0cd5cdad5" class="shiny-html-output"></div>

<script type="application/shiny-prerendered" data-context="server-start">
library(knitr)
opts_chunk$set(warning = FALSE, message = FALSE, dev.args = list(bg = 'transparent', family = 'serif'), eval = T, echo = F)

library(tidyverse)
library(shiny)
library(kableExtra)

source('R/funcs.R')

data(dissdat)
data(lengdat)
data(envdatdelt)
data(shoreloc)
data(crbs)

# abundance data
abudat <- crbs %>% 
  select(CTD, abundances) %>% 
  na.omit

# get all values and only ph delt
envdatdelt <- envdatdelt %>% 
  gather('envtyp', 'envval', val, delt) %>% 
  unite('var', var, envtyp, sep = '') %>% 
  filter(grepl('val$|^pHdelt$', var)) %>% 
  mutate(var = gsub('\\val$', '', var)) %>% 
  rename(val = envval)
</script>
 
<script type="application/shiny-prerendered" data-context="server">
# combined dissolution, length data to plot, model
dislendat <- reactive({
  
  # input
  lng <- input$lng
  
  out <- inner_join(lengdat, dissdat, by = 'CTD') %>% 
    filter(lenvar %in% lng)

  return(out)
  
})

# regression models in plot, length
dislenmod <- reactive({
  
  # input
  dislendat <- dislendat()

  ## model output
  
  # all data
  allmods <- dislendat %>% 
    group_by(prt) %>% 
    nest %>% 
    mutate(
      mod = map(data, function(x){
        
        lm(avelen ~ disval, data = x) %>% 
          summary
        
      }),
      dattyp = 'All data'
    )
  
  # onshore only
  onsmods <- dislendat %>% 
    filter(shoreloc %in% 'onshore') %>% 
    group_by(prt) %>% 
    nest %>% 
    mutate(
      mod = map(data, function(x){
        
        lm(avelen ~ disval, data = x) %>% 
          summary
        
      }),
      dattyp = 'On shore'
    )
  
  # combine models get summaries
  out <- rbind(allmods, onsmods) %>% 
    mutate(summod = map(mod, getsum)) %>% 
    select(prt, dattyp, summod) %>% 
    unnest %>% 
    arrange(prt, dattyp) %>% 
    rename(
      `Crab body location` = prt, 
      `Model subset` = dattyp
    )
  
  return(out)
  
})

# dissolution data plot, length
dislenplo <- reactive({
  
  # input
  dislendat <- dislendat()
  
  # plot
  p <- ggplot(dislendat, aes(x = disval, y = avelen)) +
    geom_point(aes(color = shoreloc), size = 4) + 
    geom_errorbar(aes(ymin = avelen - stelen, ymax = avelen + stelen, color = shoreloc), width = 0) +
    facet_grid(~prt) + 
    geom_smooth(method = 'lm', colour = 'black', se = F) + 
    geom_smooth(aes(group = shoreloc, linetype = shoreloc), colour = 'aquamarine3', se = F, method = 'lm') +
    theme_bw(base_family = 'serif', base_size = 16) +
    theme(
      legend.title = element_blank(),
      strip.background = element_blank(),
      legend.position = 'top'
      ) +
    scale_colour_manual(values = c('deepskyblue3', 'aquamarine3')) +
    ylab('Length') + 
    xlab('Dissolution') +
    scale_linetype_manual(values = c(0, 2))
  
  return(p)

})

# combined dissolution, abundance data to plot, model
disabudat <- reactive({
  
  # input
  loc <- input$loc
  
  abudat <- crbs %>% 
    select(CTD, abundances) %>% 
    na.omit

  out <- inner_join(abudat, dissdat, by = 'CTD') %>% 
    left_join(shoreloc, by = 'CTD')
  return(out)
  
})

# regression models in plot, abundance
disabumod <- reactive({
  
  # input
  disabudat <- disabudat()
  logm <- input$logm
  ## model output
  
  # all data
  allmods <- disabudat %>% 
    group_by(prt) %>% 
    nest %>% 
    mutate(
      mod = map(data, function(x){
        
        if(logm)
          modout <- lm(log10(1 + abundances) ~ disval, data = x)
        else 
          modout <- lm(abundances ~ disval, data = x)
        
        summary(modout)
        
      }),
      dattyp = 'All data'
    )
  
  # onshore only
  onsmods <- disabudat %>% 
    filter(shoreloc %in% 'onshore') %>% 
    group_by(prt) %>% 
    nest %>% 
    mutate(
      mod = map(data, function(x){
        
        if(logm)
          modout <- lm(log10(1 + abundances) ~ disval, data = x)
        else 
          modout <- lm(abundances ~ disval, data = x)
        
        summary(modout)
        
      }),
      dattyp = 'On shore'
    )
  
  # combine models get summaries
  out <- rbind(allmods, onsmods) %>% 
    mutate(summod = map(mod, getsum)) %>% 
    select(prt, dattyp, summod) %>% 
    unnest %>% 
    arrange(prt, dattyp) %>% 
    rename(
      `Crab body location` = prt, 
      `Model subset` = dattyp
    )
    
  return(out)
  
})

# dissolution data plot, abundance
disabuplo <- reactive({
  
  # input
  disabudat <- disabudat()
  logm <- input$logm
  
  # plot
  if(!as.logical(logm)){
    p <- ggplot(disabudat, aes(x = disval, y = abundances)) +
      geom_point(aes(color = shoreloc), size = 4) + 
      facet_grid(~prt) + 
      geom_smooth(method = 'lm', colour = 'black', se = F) + 
      geom_smooth(aes(group = shoreloc, linetype = shoreloc), colour = 'aquamarine3', se = F, method = 'lm') +
      theme_bw(base_family = 'serif', base_size = 16) +
      theme(
        legend.title = element_blank(),
        strip.background = element_blank(),
        legend.position = 'top'
        ) +
      scale_colour_manual(values = c('deepskyblue3', 'aquamarine3')) +
      ylab('Counts') + 
      xlab('Dissolution') +
      scale_linetype_manual(values = c(0, 2))
  } else {
    p <- ggplot(disabudat, aes(x = disval, y = log10(1 + abundances))) +
      geom_point(aes(color = shoreloc), size = 4) + 
      facet_grid(~prt) + 
      geom_smooth(method = 'lm', colour = 'black', se = F) + 
      geom_smooth(aes(group = shoreloc, linetype = shoreloc), colour = 'aquamarine3', se = F, method = 'lm') +
      theme_bw(base_family = 'serif', base_size = 16) +
      theme(
        legend.title = element_blank(),
        strip.background = element_blank(),
        legend.position = 'top'
        ) +
      scale_colour_manual(values = c('deepskyblue3', 'aquamarine3')) +
      ylab('log-Counts') + 
      xlab('Dissolution') +
      scale_linetype_manual(values = c(0, 2))
  }
  
  return(p)
})

# combined length, abundance data to plot, model
lenabudat <- reactive({
  
  # input
  lng <- input$lng
  
  out <- inner_join(abudat, lengdat, by = 'CTD') %>% 
    filter(lenvar %in% lng) 

  return(out)
  
})

# regression models in plot, abundance and length
lenabumod <- reactive({
  
  # input
  lenabudat <- lenabudat()
  logm <- input$logm

  ## model output

  # all data
  allmods <- lenabudat %>% 
    nest %>% 
    mutate(
      mod = map(data, function(x){
        
        if(logm)
          modout <- lm(log10(1 + abundances) ~ avelen, data = x)
        else 
          modout <- lm(abundances ~ avelen, data = x)
        
        summary(modout)
        
      }),
      dattyp = 'All data'
    )
  
  # onshore only
  onsmods <- lenabudat %>% 
    filter(shoreloc %in% 'onshore') %>% 
    nest %>% 
    mutate(
      mod = map(data, function(x){
        
        if(logm)
          modout <- lm(log10(1 + abundances) ~ avelen, data = x)
        else 
          modout <- lm(abundances ~ avelen, data = x)
        
        summary(modout)
        
      }),
      dattyp = 'On shore'
    )
  
  # combine models get summaries
  out <- rbind(allmods, onsmods) %>% 
    mutate(summod = map(mod, getsum)) %>%
    select(dattyp, summod) %>% 
    unnest %>% 
    arrange(dattyp) %>% 
    rename(
      `Model subset` = dattyp
    )
    
  return(out)
  
})

# dissolution data plot, abundance, length
lenabuplo <- reactive({
  
  # input
  lenabudat <- lenabudat()
  logm <- input$logm
  
  # plot
  if(!as.logical(logm)){
    p <- ggplot(lenabudat, aes(x = avelen, y = abundances)) +
      geom_point(aes(color = shoreloc), size = 4) + 
      geom_errorbarh(aes(xmin = avelen - stelen, xmax = avelen + stelen, color = shoreloc), height = 0) +
      geom_smooth(method = 'lm', colour = 'black', se = F) + 
      geom_smooth(aes(group = shoreloc, linetype = shoreloc), colour = 'aquamarine3', se = F, method = 'lm') +
      theme_bw(base_family = 'serif', base_size = 16) +
      theme(
        legend.title = element_blank(),
        strip.background = element_blank(),
        legend.position = 'top'
        ) +
      scale_colour_manual(values = c('deepskyblue3', 'aquamarine3')) +
      ylab('Counts') + 
      xlab('Length') +
      scale_linetype_manual(values = c(0, 2))
  } else {
    p <- ggplot(lenabudat, aes(x = avelen, y = log10(1 + abundances))) +
      geom_point(aes(color = shoreloc), size = 4) + 
      geom_errorbarh(aes(xmin = avelen - stelen, xmax = avelen + stelen, color = shoreloc), height = 0) +
      geom_smooth(method = 'lm', colour = 'black', se = F) + 
      geom_smooth(aes(group = shoreloc, linetype = shoreloc), colour = 'aquamarine3', se = F, method = 'lm') +
      theme_bw(base_family = 'serif', base_size = 16) +
      theme(
        legend.title = element_blank(),
        strip.background = element_blank(),
        legend.position = 'top'
        ) +
      scale_colour_manual(values = c('deepskyblue3', 'aquamarine3')) +
      ylab('log-Counts') + 
      xlab('Length') +
      scale_linetype_manual(values = c(0, 2))
  }
  
  return(p)

})

# environmental data for selected depth
envdep <- reactive({
  
  # inputs
  dep <- input$dep
  
  out <- envdatdelt %>% 
    filter(depth %in% dep) %>% 
    select(-depth) %>% 
    filter(var %in% c('Aragonite', 'Fluorescence', 'Oxygen', 'Temperature', 'pCO2', 'pH', 'pHdelt'))
  
  return(out)
  
})

# VIF values for envdep
envdepvif <- reactive({
  
  # input
  envdep <- envdep()

  # get vif values
  out <- envdep %>% 
    spread(var, val) %>% 
    dplyr::select(Aragonite, Fluorescence, pCO2, Oxygen, pH, Temperature) %>% 
    nest %>% 
    mutate(
      vifchk = map(data, function(x){

        # get vif values for each var against the others
        val <- NULL
        for(i in names(x)){
          
          yval <- i
          xvals <- names(x)[!names(x) %in% i] %>% 
            paste(collapse = ' + ')
          
          frm <- formula(paste(yval, '~', xvals))
          mod <- lm(frm, x)
          rsq <- mod %>% 
            summary %>% 
            .$r.squared
          vif <- 1 / (1 - rsq)
          
          val <- c(val, vif)
          
        }
        
        # format vif values as data frame for unnest
        names(val) <- names(x)
        val <- val %>% 
          as.list %>% 
          data.frame %>% 
          round(1)
        
        return(val)
        
      })
    ) %>% 
    select(-data) %>% 
    unnest
  
  return(out)

})

# dissolution data with environmental data
disenvdat <- reactive({
  
  # input
  envdep <- envdep()

  out <- inner_join(envdep, dissdat, by = 'CTD') %>% 
    left_join(shoreloc, by = 'CTD')

  return(out)
  
})

# dissolution models with environmental data
disenvmod <- reactive({

  # input
  disenvdat <- disenvdat()

  ## model output

  # all data
  allmods <- disenvdat %>%
    group_by(var, prt) %>% 
    nest %>%
    mutate(
      mod = map(data, function(x){

        modout <- lm(disval ~ val, data = x)
        summary(modout)

      }),
      dattyp = 'All data'
    )

  # onshore only
  onsmods <- disenvdat %>%
    group_by(var, prt) %>% 
    filter(shoreloc %in% 'onshore') %>%
    nest %>%
    mutate(
      mod = map(data, function(x){

        modout <- lm(disval ~ val, data = x)
        summary(modout)

      }),
      dattyp = 'On shore'
    )

  # combine models get summaries
  out <- rbind(allmods, onsmods) %>%
    mutate(summod = map(mod, getsum)) %>%
    select(var, prt, dattyp, summod) %>%
    unnest %>%
    arrange(var, prt, dattyp) %>%
    rename(
      `Crab body location` = prt, 
      `Model subset` = dattyp, 
      `Environmental variable` = var
    )

  return(out)
  
})

# dissolution data plot, environment
disenvplo <- reactive({
  
  # input
  disenvdat <- disenvdat()

  # plot
  p <- ggplot(disenvdat, aes(x = val, y = disval)) +
    geom_point(aes(color = shoreloc), size = 4) + 
    facet_grid(prt ~ var, scales = 'free_x') + 
    geom_smooth(method = 'lm', colour = 'black', se = F) + 
    geom_smooth(aes(group = shoreloc, linetype = shoreloc), colour = 'aquamarine3', se = F, method = 'lm') +
    theme_bw(base_family = 'serif', base_size = 16) +
    theme(
      legend.title = element_blank(),
      strip.background = element_blank(),
      legend.position = 'top'
      ) +
    scale_colour_manual(values = c('deepskyblue3', 'aquamarine3')) +
    ylab('Dissolution') + 
    xlab('Environmental variable') +
    scale_linetype_manual(values = c(0, 2))
  
  return(p)
  
})

# length data with environmental data
lenenvdat <- reactive({
  
  # input
  envdep <- envdep()
  lng <- input$lng

  out <- inner_join(envdep, lengdat, by = 'CTD') %>% 
    filter(lenvar %in% lng)

  return(out)
  
})

# length models with environmental data
lenenvmod <- reactive({

  # input
  lenenvdat <- lenenvdat()

  ## model output

  # all data
  allmods <- lenenvdat %>%
    group_by(var) %>% 
    nest %>%
    mutate(
      mod = map(data, function(x){

        modout <- lm(avelen ~ val, data = x)
        summary(modout)

      }),
      dattyp = 'All data'
    )

  # onshore only
  onsmods <- lenenvdat %>%
    group_by(var) %>% 
    filter(shoreloc %in% 'onshore') %>%
    nest %>%
    mutate(
      mod = map(data, function(x){

        modout <- lm(avelen ~ val, data = x)
        summary(modout)

      }),
      dattyp = 'On shore'
    )

  # combine models get summaries
  out <- rbind(allmods, onsmods) %>%
    mutate(summod = map(mod, getsum)) %>%
    select(var, dattyp, summod) %>%
    unnest %>%
    arrange(var, dattyp) %>%
    rename(
      `Model subset` = dattyp, 
      `Environmental variable` = var
    )

  return(out)
  
})

# length data plot, environment
lenenvplo <- reactive({
  
  # input
  lenenvdat <- lenenvdat()

  # plot
  p <- ggplot(lenenvdat, aes(x = val, y = avelen)) +
    geom_point(aes(color = shoreloc), size = 4) + 
    geom_errorbar(aes(ymin = avelen - stelen, ymax = avelen + stelen, color = shoreloc), width = 0) +
    facet_grid( ~ var, scales = 'free_x') + 
    geom_smooth(method = 'lm', colour = 'black', se = F) + 
    geom_smooth(aes(group = shoreloc, linetype = shoreloc), colour = 'aquamarine3', se = F, method = 'lm') +
    theme_bw(base_family = 'serif', base_size = 16) +
    theme(
      legend.title = element_blank(),
      strip.background = element_blank(),
      legend.position = 'top'
      ) +
    scale_colour_manual(values = c('deepskyblue3', 'aquamarine3')) +
    ylab('Length') + 
    xlab('Environmental variable') +
    scale_linetype_manual(values = c(0, 2))
  
  return(p)
  
})

# abundance data with environmental data
abuenvdat <- reactive({
  
  # input
  envdep <- envdep()
  lng <- input$lng
  # browser()
  out <- inner_join(envdep, abudat, by = 'CTD') %>% 
    left_join(shoreloc, by = 'CTD') #%>% 
    # filter(!is.na(shoreloc))
  
  return(out)
  
})

# regression models in plot, abundance
abuenvmod <- reactive({
  
  # input
  abuenvdat <- abuenvdat()
  logm <- input$logm

  ## model output
  
  # all data
  allmods <- abuenvdat %>% 
    group_by(var) %>% 
    nest %>% 
    mutate(
      mod = map(data, function(x){
        
        if(logm)
          modout <- lm(log10(1 + abundances) ~ val, data = x)
        else 
          modout <- lm(abundances ~ val, data = x)
        
        summary(modout)
        
      }),
      dattyp = 'All data'
    )
  
  # # onshore only
  # onsmods <- abuenvdat %>% 
  #   filter(shoreloc %in% 'onshore') %>% 
  #   group_by(var) %>% 
  #   nest %>% 
  #   mutate(
  #     mod = map(data, function(x){
  #       
  #       if(logm)
  #         modout <- lm(log10(abundances) ~ val, data = x)
  #       else 
  #         modout <- lm(abundances ~ val, data = x)
  #       
  #       summary(modout)
  #       
  #     }),
  #     dattyp = 'On shore'
  #   )
  
  # combine models get summaries
  out <- rbind(allmods) %>% #, onsmods) %>% 
    mutate(summod = map(mod, getsum)) %>% 
    select(var, dattyp, summod) %>% 
    unnest %>% 
    arrange(var, dattyp) %>% 
    rename(
      `Environmental variable` = var,
      `Model subset` = dattyp
    )
    
  return(out)
  
})

# aundance data plot, environment
abuenvplo <- reactive({
  
  # input
  logm <- input$logm
  abuenvdat <- abuenvdat()

  # plot
  if(!as.logical(logm)){
    
    p <- ggplot(abuenvdat, aes(x = val, y = abundances)) +
      geom_point(size = 4) + 
      facet_grid( ~ var, scales = 'free_x') + 
      geom_smooth(method = 'lm', colour = 'black', se = F) + 
      theme_bw(base_family = 'serif', base_size = 16) +
      theme(
        legend.title = element_blank(),
        strip.background = element_blank(),
        legend.position = 'top'
        ) +
      ylab('Counts') + 
      xlab('Environmental variable') 

  } else {
    
    p <- ggplot(abuenvdat, aes(x = val, y = log10(1 + abundances))) +
      geom_point(size = 4) +
      facet_grid( ~ var, scales = 'free_x') +
      geom_smooth(method = 'lm', colour = 'black', se = F) +
      theme_bw(base_family = 'serif', base_size = 16) +
      theme(
        legend.title = element_blank(),
        strip.background = element_blank(),
        legend.position = 'top'
        ) +
      ylab('Counts') +
      xlab('Environmental variable')
    
  }
  
  return(p)
  
})

# presence absence data with environmental data
prsenvdat <- reactive({
  
  # input
  envdep <- envdep()
  
  out <- inner_join(envdep, abudat, by = 'CTD') %>% 
    mutate(prs = ifelse(abundances > 0, 1, 0)) %>% 
    select(-abundances)
  
  return(out)
  
})

# regression models in plot, presence absence
prsenvmod <- reactive({
  
  # input
  prsenvdat <- prsenvdat()

  ## model output
  
  # all data
  allmods <- prsenvdat %>% 
    group_by(var) %>% 
    nest %>% 
    mutate(
      mod = map(data, function(x){
        
        modout <- glm(prs ~ val, family = binomial(link = 'logit'), data = x)
        modout
        
      }),
      dattyp = 'All data'
    )

  # combine models get summaries
  out <- allmods %>% 
    mutate(summod = map(mod, getsum)) %>% 
    select(var, dattyp, summod) %>% 
    unnest %>% 
    arrange(var, dattyp) %>% 
    rename(
      `Environmental variable` = var,
      `Model subset` = dattyp
    )
    
  return(out)
  
})

# aundance data plot, environment
prsenvplo <- reactive({
  
  # input
  prsenvdat <- prsenvdat()

  # plot
  p <- ggplot(prsenvdat, aes(x = val, y = prs)) +
    geom_point(size = 4, alpha = 0.7) + 
    facet_grid( ~ var, scales = 'free_x') + 
    geom_smooth(method = "glm", method.args = list(family = "binomial")) +
    theme_bw(base_family = 'serif', base_size = 16) +
    theme(
      legend.title = element_blank(),
      strip.background = element_blank(),
      legend.position = 'top'
      ) +
    ylab('Presence/absence') + 
    xlab('Environmental variable')
  
  return(p)
  
})
</script>
 <!--html_preserve-->
<script type="application/shiny-prerendered" data-context="dependencies">
{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["jquery"]},{"type":"character","attributes":{},"value":["1.11.3"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["rmd/h/jquery-1.11.3"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["jquery.min.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["rmarkdown"]},{"type":"logical","attributes":{},"value":[true]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["bootstrap"]},{"type":"character","attributes":{},"value":["3.3.5"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["rmd/h/bootstrap-3.3.5"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["viewport"]}},"value":[{"type":"character","attributes":{},"value":["width=device-width, initial-scale=1"]}]},{"type":"character","attributes":{},"value":["js/bootstrap.min.js","shim/html5shiv.min.js","shim/respond.min.js"]},{"type":"character","attributes":{},"value":["css/bootstrap.min.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["rmarkdown"]},{"type":"logical","attributes":{},"value":[true]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["jquery"]},{"type":"character","attributes":{},"value":["1.11.3"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["rmd/h/jquery-1.11.3"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["jquery.min.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["rmarkdown"]},{"type":"logical","attributes":{},"value":[true]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["navigation"]},{"type":"character","attributes":{},"value":["1.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["rmd/h/navigation-1.1"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["tabsets.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["rmarkdown"]},{"type":"logical","attributes":{},"value":[true]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["highlightjs"]},{"type":"character","attributes":{},"value":["9.12.0"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["rmd/h/highlightjs"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["highlight.js"]},{"type":"character","attributes":{},"value":["default.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["rmarkdown"]},{"type":"logical","attributes":{},"value":[true]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["selectize"]},{"type":"character","attributes":{},"value":["0.11.2"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["href"]}},"value":[{"type":"character","attributes":{},"value":["shared/selectize"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["css/selectize.bootstrap3.css"]},{"type":"character","attributes":{},"value":["<!--[if lt IE 9]>\n<script src=\"shared/selectize/js/es5-shim.min.js\"><\/script>\n<![endif]-->\n<script src=\"shared/selectize/js/selectize.min.js\"><\/script>"]},{"type":"NULL"},{"type":"NULL"},{"type":"logical","attributes":{},"value":[true]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["selectize"]},{"type":"character","attributes":{},"value":["0.11.2"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["href"]}},"value":[{"type":"character","attributes":{},"value":["shared/selectize"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["css/selectize.bootstrap3.css"]},{"type":"character","attributes":{},"value":["<!--[if lt IE 9]>\n<script src=\"shared/selectize/js/es5-shim.min.js\"><\/script>\n<![endif]-->\n<script src=\"shared/selectize/js/selectize.min.js\"><\/script>"]},{"type":"NULL"},{"type":"NULL"},{"type":"logical","attributes":{},"value":[true]}]}]}
</script>
<!--/html_preserve-->
</div>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
