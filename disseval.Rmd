---
title: "Exploration of crab dissolution"
author: ""
output: 
  html_document:
    css: kable.css
self_contained: yes
runtime: shiny
---

```{r, message = F, warning = F, echo = F}
library(knitr)
opts_chunk$set(warning = FALSE, message = FALSE, dev.args = list(bg = 'transparent', family = 'serif'), eval = T, echo = F)

library(tidyverse)
library(shiny)

source('R/funcs.R')

data(dissdat)
data(lengdat)
data(crbs)
```

```{r selectors}
column(12,
column(4, 
       
       selectInput('lng', 'Select length measure:', choices = unique(lengdat$lenvar))
       
       ),
column(4, 
       
       selectInput('dss', 'Select dissolution measure:', choices = unique(dissdat$distyp))
       
       )
)
```

```{r reactives}
# combined dissolution, length data to plot, model
dislendat <- reactive({
  
  # input
  lng <- input$lng
  dss <- input$dss
  loc <- input$loc
  
  out <- inner_join(lengdat, dissdat, by = 'CTD') %>% 
    filter(lenvar %in% lng) %>% 
    filter(distyp %in% dss) 

  return(out)
  
})

# regression models in plot, length
dislenmod <- reactive({
  
  # input
  dislendat <- dislendat()

  ## model output
  
  # all data
  allmods <- dislendat %>% 
    group_by(prt) %>% 
    nest %>% 
    mutate(
      mod = map(data, function(x){
        
        lm(avelen ~ disval, data = x) %>% 
          summary
        
      }),
      dattyp = 'All data'
    )
  
  # onshore only
  onsmods <- dislendat %>% 
    filter(shoreloc %in% 'onshore') %>% 
    group_by(prt) %>% 
    nest %>% 
    mutate(
      mod = map(data, function(x){
        
        lm(avelen ~ disval, data = x) %>% 
          summary
        
      }),
      dattyp = 'On shore'
    )
  
  # combine models get summaries
  out <- rbind(allmods, onsmods) %>% 
    mutate( 
      summod = map(mod, ~data.frame(

        `F-stat` = .x$fstatistic[1],
        `p-mod` = p_ast(pf(.x$fstatistic[1], .x$fstatistic[2], .x$fstatistic[3], lower.tail = F)),
        R2 = .x$r.squared, 
        slope = coefficients(.x)[2, 1],
        `t-stat` = coefficients(.x)[2, 3],
        `p-slope` = p_ast(coefficients(.x)[2, 4]),
        stringsAsFactors = F
        
      )
    )
  ) %>% 
  select(prt, dattyp, summod) %>% 
  unnest %>% 
  arrange(prt, dattyp) %>% 
  rename(
    `Crab body location` = prt, 
    `Model subset` = dattyp
  )
  
  return(out)
  
})

# dissolution data plot, length
dislenplo <- reactive({
  
  # input
  dislendat <- dislendat()
  
  # plot
  p <- ggplot(dislendat, aes(x = disval, y = avelen)) +
    geom_point(aes(color = shoreloc), size = 4) + 
    geom_errorbar(aes(ymin = avelen - stelen, ymax = avelen + stelen, color = shoreloc), width = 0.1) +
    facet_grid(~prt) + 
    geom_smooth(method = 'lm', colour = 'black', se = F) + 
    geom_smooth(aes(group = shoreloc, linetype = shoreloc), colour = 'aquamarine3', se = F, method = 'lm') +
    theme_bw(base_family = 'serif', base_size = 16) +
    theme(
      legend.title = element_blank(),
      strip.background = element_blank(),
      legend.position = 'top'
      ) +
    scale_colour_manual(values = c('deepskyblue3', 'aquamarine3')) +
    ylab('Length') + 
    xlab('Dissolution') +
    scale_linetype_manual(values = c(0, 2))
  
  return(p)

})

# combined dissolution, abundance data to plot, model
disabudat <- reactive({
  
  # input
  dss <- input$dss
  loc <- input$loc
  
  abudat <- crbs %>% 
    select(CTD, abundances) %>% 
    na.omit

  shoreloc <- lengdat %>% 
    select(CTD, shoreloc) %>% 
    unique
  
  out <- inner_join(abudat, dissdat, by = 'CTD') %>% 
    left_join(shoreloc, by = 'CTD') %>% 
    filter(distyp %in% dss) 

  return(out)
  
})

# regression models in plot, abundance
disabumod <- reactive({
  
  # input
  disabudat <- disabudat()
  logm <- input$logm

  ## model output
  
  # all data
  allmods <- disabudat %>% 
    group_by(prt) %>% 
    nest %>% 
    mutate(
      mod = map(data, function(x){
        
        if(logm)
          modout <- lm(log10(abundances) ~ disval, data = x)
        else 
          modout <- lm(abundances ~ disval, data = x)
        
        summary(modout)
        
      }),
      dattyp = 'All data'
    )
  
  # onshore only
  onsmods <- disabudat %>% 
    filter(shoreloc %in% 'onshore') %>% 
    group_by(prt) %>% 
    nest %>% 
    mutate(
      mod = map(data, function(x){
        
        if(logm)
          modout <- lm(log10(abundances) ~ disval, data = x)
        else 
          modout <- lm(abundances ~ disval, data = x)
        
        summary(modout)
        
      }),
      dattyp = 'On shore'
    )
  
  # combine models get summaries
  out <- rbind(allmods, onsmods) %>% 
    mutate( 
      summod = map(mod, ~data.frame(

        `F-stat` = .x$fstatistic[1],
        `p-mod` = p_ast(pf(.x$fstatistic[1], .x$fstatistic[2], .x$fstatistic[3], lower.tail = F)),
        R2 = .x$r.squared, 
        slope = coefficients(.x)[2, 1],
        `t-stat` = coefficients(.x)[2, 3],
        `p-slope` = p_ast(coefficients(.x)[2, 4]),
        stringsAsFactors = F
        
      )
    )
  ) %>% 
  select(prt, dattyp, summod) %>% 
  unnest %>% 
  arrange(prt, dattyp) %>% 
  rename(
    `Crab body location` = prt, 
    `Model subset` = dattyp
  )
  
  return(out)
  
})

# dissolution data plot, abundance
disabuplo <- reactive({
  
  # input
  disabudat <- disabudat()
  logm <- input$logm
  
  # plot
  p <- ggplot(disabudat, aes(x = disval, y = abundances)) +
    geom_point(aes(color = shoreloc), size = 4) + 
    facet_grid(~prt) + 
    geom_smooth(method = 'lm', colour = 'black', se = F) + 
    geom_smooth(aes(group = shoreloc, linetype = shoreloc), colour = 'aquamarine3', se = F, method = 'lm') +
    theme_bw(base_family = 'serif', base_size = 16) +
    theme(
      legend.title = element_blank(),
      strip.background = element_blank(),
      legend.position = 'top'
      ) +
    scale_colour_manual(values = c('deepskyblue3', 'aquamarine3')) +
    ylab('Counts') + 
    xlab('Dissolution') +
    scale_linetype_manual(values = c(0, 2))
  
  if(logm)
    p <- p + scale_y_log10('log-Counts')
  
  return(p)

})
```
## {.tabset} 

### Length vs dissolution 

These plots show the relationship between dissolution and length for the selected measures above.  Each point is based on an aggregated dissolution measure (as an average from three replicates) and the corresponding lengths for the same station.  The length values are also aggregated but represent average length across multiple individuals that were collected at a station.  The error bars around the length represent 95% confidence intervals for the length measurements.  The regression lines were fit for the average dissolution and length measurements, where the black line is for all points and the dotted line is fit only for sites identified as onshore.  

```{r}
renderPlot({dislenplo()}, height = 300, width = 900)
```

The table shows summary statistics for each linear model in the above plot.  The crab body location is where the dissolution was measured (plot facets) and the model subset indicates the appropriate regression model in each plot facet.  The summary information are F-statistics (`F.stat`, whole model), p-value (`p.mod`, whole model), R-squared (`R2`), `slope` (slope estimate for length vs dissolution), t-statistic (`t.stat`, test statistics for slope), and p-value (`p.slope`, significance of slope). ns: p >= 0.05, \* p < 0.05, ** p < 0.01
```{r}
renderTable({dislenmod()})
```

### Abundance vs dissolution

```{r}
selectInput('logm', 'Log models:', choices = c(TRUE, FALSE))
```


These plots show the relationship between dissolution and abundance for the selected measures above.  Each point is based on an aggregated dissolution measure (as an average from three replicates) and the corresponding abundance (count) for the same station.  The regression lines were fit for the average dissolution and abundance measurements, where the black line is for all points and the dotted line is fit only for sites identified as onshore.  

```{r}
renderPlot({disabuplo()}, height = 300, width = 900)
```

The table shows summary statistics for each linear model in the above plot.  The crab body location is where the dissolution was measured (plot facets) and the model subset indicates the appropriate regression model in each plot facet.  The summary information are F-statistics (`F.stat`, whole model), p-value (`p.mod`, whole model), R-squared (`R2`), `slope` (slope estimate for abundance vs dissolution), t-statistic (`t.stat`, test statistics for slope), and p-value (`p.slope`, significance of slope). ns: p >= 0.05, \* p < 0.05, ** p < 0.01
```{r}
renderTable({disabumod()})
```

