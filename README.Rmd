---
title: "README"
author: "Marcus Beck"
output: 
  html_document:
    code_folding: show
self_contained: yes
---

```{r setup, echo = F}
library(knitr)
opts_chunk$set(warning = F, message = F)
```

## Models {.tabset}

### 30 meters

#### Linear regression
```{r}
library(tidyverse)
library(GGally)
library(glmulti)
library(MuMIn)

data(crbs)
data(envdat)

# exp vars to use
kpvars <- c('pH', 'Temperature', 'Salinity', 'Ammonia', 'Aragonite')

# model globals
resp <- c(
    abundances = 'log(1+val)', 
    pa = 'val', 
    Average.CL = 'val'
  ) %>% 
  enframe('res', 'resp') %>% 
  group_by(res) %>% 
  nest(.key = 'resp') %>% 
  mutate(
    resp = map(resp, ~ paste(.x, paste(kpvars, collapse = '+'), sep = '~'))
    )
fams <- list(
    abundances = gaussian(), 
    pa = binomial(), 
    Average.CL = gaussian()
  ) %>% 
  enframe('res', 'dist')

# data prep, nested for mods
tomod <- envdat %>% 
  filter(depth %in% c(10, 200)) %>% 
  left_join(crbs, by = 'CTD') %>% 
  gather('var', 'val', -CTD, -abundances, -pa, -Average.CL, -depth) %>% 
  group_by(var) %>% 
  mutate(
    val = scale(val)
  ) %>% 
  spread(var, val) %>% 
  dplyr::select_(.dots = c('depth', 'abundances', 'pa', 'Average.CL', kpvars)) %>% 
  gather('res', 'val', abundances, pa, Average.CL) %>% 
  dplyr::select(depth, res, val, everything()) %>% 
  group_by(depth, res) %>% 
  nest %>% 
  left_join(fams, by = 'res') %>% 
  left_join(resp, by = 'res')

```
```{r, fig.height = 8, fig.width = 8}
# correlation matrix to plot
toplo <- tomod %>% 
  filter(res == 'abundances') %>% 
  dplyr::select(data) %>% 
  unnest %>% 
  .[, c('val', kpvars)] %>% 
  rename(abundance = val) %>% 
  mutate(val = log(1 + val))
  
# plot
ggpairs(toplo)
```
```{r, eval = T, fig.height = 5, fig.width = 8}
# models
mods <- tomod %>% 
  mutate(
    moddat = pmap(list(data, dist, resp), function(data, dist, resp){

      # filter data to remove NA
      x <- data %>% 
        filter(!is.na(val))
      
      cffs <- glmulti(y = formula(resp), data = x, level = 1, crit = 'aicc', plotty = F, 
                       family = dist, report = F) %>% 
        coef %>% 
        data.frame %>% 
        rownames_to_column('var')

      # top five AICc models
      globs <- glm(resp, data = x, na.action = na.pass, family = dist)
      drdg <- dredge(globs) %>% 
        data.frame %>% 
        .[1:5, ]

      out <- list(drdg, cffs)
      return(out)
      
    })
    
  ) %>% 
  select(depth, res, moddat) %>% 
  mutate(
    tops = map(moddat, ~ .x[[1]]),
    cffs = map(moddat, ~ .x[[2]])
  ) %>% 
  select(-moddat)
```

```{r}
# tabular
totab <- mods %>% 
  select(-cffs) %>% 
  unnest
```

```{r}
# toplot
toplo <- mods %>% 
  select(-tops) %>% 
  unnest %>% 
  filter(!var %in% '(Intercept)')
names(toplo) <- gsub('\\.*', '', names(toplo))

ggplot(toplo, aes(x = var, y = Importance, fill = factor(depth))) + 
  geom_bar(stat = 'identity', position = 'dodge') + 
  theme_bw() + 
  facet_wrap(~ res)

ggplot(toplo, aes(x = var, y = Estimate, group = factor(depth), fill = factor(depth))) + 
  geom_bar(stat = 'identity', position = 'dodge') + 
  # geom_errorbar(aes(ymin = Estimate - Xalpha005, ymax = Estimate + Xalpha005), position = 'dodge') +
  theme_bw() + 
  facet_wrap(~ res, scales = 'free_y')

```


