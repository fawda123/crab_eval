---
title: "README"
author: "Marcus Beck"
output: 
  html_document:
    code_folding: show
self_contained: yes
---

```{r setup, echo = F}
library(knitr)
opts_chunk$set(warning = F, message = F)
```

## Models {.tabset}

### 30 meters

#### Linear regression
```{r}
library(tidyverse)
library(GGally)
library(glmulti)
library(MuMIn)
library(gridExtra)
source('R/funcs.R')

data(crbs)
data(envdat)

# exp vars to use
kpvars <- c('pH', 'Temperature', 'Salinity', 'Ammonia', 'Aragonite')

# model globals
resp <- c(
    abundances = 'log(1+val)', 
    pa = 'val', 
    Average.CL = 'val'
  ) %>% 
  enframe('res', 'resp') %>% 
  group_by(res) %>% 
  nest(.key = 'resp') %>% 
  mutate(
    resp = map(resp, ~ paste(.x, paste(kpvars, collapse = '+'), sep = '~'))
    )
fams <- list(
    abundances = gaussian, 
    pa = binomial, 
    Average.CL = gaussian
  ) %>% 
  enframe('res', 'dist')

# data prep, nested for mods
tomod <- envdat %>% 
  filter(depth %in% c(10, 200)) %>% 
  left_join(crbs, by = 'CTD') %>% 
  gather('var', 'val', -CTD, -abundances, -pa, -Average.CL, -depth) %>% 
  group_by(var) %>% 
  mutate(
    val = scale(val)
  ) %>% 
  spread(var, val) %>% 
  dplyr::select_(.dots = c('depth', 'abundances', 'pa', 'Average.CL', kpvars)) %>% 
  gather('res', 'val', abundances, pa, Average.CL) %>% 
  dplyr::select(depth, res, val, everything()) %>% 
  group_by(depth, res) %>% 
  nest %>% 
  left_join(fams, by = 'res') %>% 
  left_join(resp, by = 'res')

```
```{r, fig.height = 8, fig.width = 8}
# correlation matrix to plot
toplo <- tomod %>% 
  filter(res == 'abundances') %>% 
  dplyr::select(data) %>% 
  unnest %>% 
  .[, c('val', kpvars)] %>% 
  rename(abundance = val) %>% 
  mutate(abundance = log(1 + abundance))
  
# plot
ggpairs(toplo)
```
```{r, eval = T, fig.height = 5, fig.width = 8}
# models
mods <- tomod %>% 
  mutate(
    moddat = pmap(list(data, dist, resp), function(data, dist, resp){

      # filter data to remove NA
      x <- data %>% 
        filter(!is.na(val))

      cffs <- do.call('glmulti',
                      list(formula(resp), data = x, level = 1, method = 'h', crit = 'aicc', plotty = F, report = F, fitfunction = 'glm', family = dist)) %>%            
        coef %>%
        data.frame %>%
        rownames_to_column('var')

      # top five AICc models
      globs <- glm(resp, data = x, na.action = na.pass, family = dist)
      drdg <- dredge(globs) %>% 
        data.frame %>% 
        .[1:5, ]

      out <- list(drdg, cffs)
      return(out)
      
    })
    
  ) %>% 
  select(depth, res, moddat) %>% 
  mutate(
    tops = map(moddat, ~ .x[[1]]),
    cffs = map(moddat, ~ .x[[2]])
  ) %>% 
  select(-moddat)
```

```{r}
# tabular
totab <- mods %>% 
  select(-cffs) %>% 
  unnest
```

```{r, fig.height = 6, fig.width = 7}
# toplot
toplo <- mods %>% 
  select(-tops) %>% 
  unnest %>% 
  filter(!var %in% '(Intercept)') %>% 
  mutate(
    `Depth (m)` = factor(depth),
    res = factor(res, 
                 levels = c('abundances', 'pa', 'Average.CL'),
                 labels = c('Abundance', 'Pres./Abs.', 'Ave. carapace length'))
    )
names(toplo) <- gsub('\\.*', '', names(toplo))

thm <- theme_bw(base_family = 'serif') + 
  theme(
    strip.background = element_blank(), 
    legend.position = 'top', 
    axis.title.x = element_blank(), 
    axis.title.y = element_blank(),
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

toplo1 <- toplo %>% 
  arrange(res, -Importance) %>% 
  mutate(var = factor(var, levels = unique(var)))
p1 <- ggplot(toplo1, aes(x = var, y = Importance, fill = `Depth (m)`)) + 
  geom_bar(stat = 'identity', position = 'dodge', colour = 'black') + 
  facet_wrap(~ res, ncol = 1,scales = 'free_y') +
  thm + 
  theme(legend.position = 'none') + 
  ggtitle('Variable importance') + 
  scale_fill_manual(values = c('lightgrey', 'darkgrey'))

toplo2 <- toplo %>% 
  arrange(res, -Estimate) %>% 
  mutate(var = factor(var, levels = unique(var)))
p2 <- ggplot(toplo2, aes(x = var, y = Estimate, group = `Depth (m)`, fill = `Depth (m)`)) + 
  geom_bar(stat = 'identity', position = 'dodge', colour = 'black') + 
  geom_hline(yintercept = 0) + 
  facet_wrap(~ res, scales = 'free_y', ncol = 1) +
  thm + 
  ggtitle('Pooled parameter estimates') + 
  scale_fill_manual(values = c('lightgrey', 'darkgrey'))
pleg <- g_legend(p2)
p2 <- p2 + theme(legend.position = 'none')
grid.arrange(
  pleg, 
  arrangeGrob(p1, p2, ncol = 2), 
  ncol = 1, heights = c(0.1, 1)
)
```


